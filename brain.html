<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>ER Trauma - Text Adventure Diagnostics</title>
    <style>
        /* ========================================
           MEDICAL TRAINING SIMULATOR - PROFESSIONAL STYLE
           ======================================== */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --bg-primary: #1a2332;
            --bg-secondary: #243447;
            --bg-panel: #2a3f5f;
            --accent-blue: #4a9eff;
            --accent-cyan: #00d9ff;
            --text-primary: #ffffff;
            --text-secondary: #b8c5d6;
            --success: #00c896;
            --warning: #ffb84d;
            --error: #ff6b6b;
            --border: #3d5a80;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0f1923 100%);
            color: var(--text-primary);
            min-height: 100vh;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            width: 100%;
        }
        
        /* ========================================
           HUD - HEADS UP DISPLAY
           ======================================== */
        #hud {
            display: none;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .hud-item {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }
        
        .hud-item span {
            color: var(--accent-cyan);
            font-weight: 700;
            font-size: 16px;
            margin-left: 5px;
        }
        
        #timer {
            color: var(--accent-cyan);
            font-weight: 700;
            font-size: 18px;
            text-shadow: 0 0 10px rgba(74, 158, 255, 0.5);
            padding: 5px 10px;
            background: rgba(74, 158, 255, 0.1);
            border-radius: 6px;
        }
        
        #timer.warning {
            color: var(--warning);
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.6);
            background: rgba(255, 193, 7, 0.15);
        }
        
        #timer.critical {
            color: var(--error);
            animation: pulse 0.8s infinite;
            text-shadow: 0 0 15px rgba(239, 83, 80, 0.8);
            background: rgba(239, 83, 80, 0.2);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.08); }
        }
        
        /* ========================================
           GAME CONTAINER
           ======================================== */
        #game-container {
            display: none;
            flex: 1;
            flex-direction: column;
            padding: 25px;
            padding-top: 90px; /* Space for ref bar at top */
            overflow: hidden;
        }
        
        /* ========================================
           OUTPUT TERMINAL
           ======================================== */
        #output {
            flex: 1;
            background: var(--bg-panel);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 15px;
            line-height: 1.6;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
            margin-bottom: 15px;
        }
        
        #output::-webkit-scrollbar {
            width: 10px;
        }
        
        #output::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 5px;
        }
        
        #output::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 5px;
        }
        
        .output-line {
            margin-bottom: 8px;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .success {
            color: var(--success);
            font-weight: 600;
        }
        
        .error {
            color: var(--error);
            font-weight: 600;
        }
        
        .info {
            color: var(--accent-cyan);
        }
        
        .warning {
            color: var(--warning);
        }
        
        /* ========================================
           INPUT AREA
           ======================================== */
        #input-container {
            display: flex;
            align-items: center;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 12px 15px;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        #input-prompt {
            color: var(--accent-cyan);
            font-family: 'Courier New', monospace;
            font-size: 18px;
            font-weight: bold;
        }
        
        #command-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 15px;
            outline: none;
            padding: 5px;
        }
        
        #command-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.5;
        }
        
        #submit-btn {
            display: none;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        #submit-btn:hover {
            background: var(--accent-cyan);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 158, 255, 0.4);
        }
        
        #submit-btn:active {
            transform: translateY(0);
        }
        
        /* ========================================
           INSTRUCTION POPUP
           ======================================== */
        #instruction-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .popup-content {
            background: var(--bg-panel);
            border: 2px solid var(--accent-cyan);
            border-radius: 12px;
            padding: 30px;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        
        .popup-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--accent-cyan);
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 2px 10px rgba(74, 158, 255, 0.5);
        }
        
        .popup-section {
            margin-bottom: 20px;
        }
        
        .popup-section h3 {
            font-size: 18px;
            color: var(--accent-blue);
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .popup-section p, .popup-section ul {
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        .popup-section ul {
            margin-left: 20px;
            list-style-type: disc;
        }
        
        .popup-section li {
            margin-bottom: 8px;
        }
        
        .standards-box {
            background: var(--bg-secondary);
            border-left: 4px solid var(--accent-cyan);
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
        }
        
        .standards-box strong {
            color: var(--accent-cyan);
        }
        
        #got-it-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 20px;
            transition: all 0.3s;
        }
        
        #got-it-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 158, 255, 0.4);
        }
        
        /* ========================================
           MOBILE RESPONSIVE
           ======================================== */
        @media (max-width: 900px) {
            body {
                padding-top: 100px; /* Space for fixed HUD + ref bar */
            }
            
            #hud {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                padding: 10px 15px;
                flex-wrap: wrap;
                gap: 8px;
                z-index: 200;
                background: var(--bg-secondary);
            }
            
            .hud-item {
                font-size: 12px;
            }
            
            #structures-reference {
                position: fixed;
                top: 50px; /* Below HUD */
                left: 0;
                right: 0;
                font-size: 10px;
                padding: 8px 10px;
                z-index: 190;
            }
            
            #game-container {
                padding: 15px;
            }
            
            #output {
                font-size: 14px;
                padding: 15px;
            }
            
            #input-container {
                margin-bottom: 20px;
            }
            
            #command-input {
                font-size: 16px;
            }
            
            #submit-btn {
                display: inline-block !important;
                padding: 12px 24px;
                margin-left: 10px;
            }
            
            .popup-content {
                max-width: 95%;
                padding: 20px;
                max-height: 80vh;
            }
            
            .popup-title {
                font-size: 22px;
            }
            
            .popup-section h3 {
                font-size: 16px;
            }
            
            .popup-section p, .popup-section ul {
                font-size: 14px;
            }
            
            #got-it-btn {
                font-size: 16px;
                padding: 12px;
            }
        }
        
        /* ========================================
           BRAIN STRUCTURES REFERENCE BAR
           ======================================== */
        #structures-reference {
            display: none;
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border);
            padding: 10px 20px;
            font-size: 11px;
            color: var(--text-secondary);
            overflow-x: auto;
            white-space: nowrap;
            position: fixed;
            top: 60px; /* Below HUD */
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        #structures-reference::-webkit-scrollbar {
            height: 6px;
        }
        
        #structures-reference::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        #structures-reference::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 3px;
        }
        
        .reference-label {
            color: var(--accent-cyan);
            font-weight: 700;
            margin-right: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 10px;
        }
        
        .structure-name {
            display: inline-block;
            padding: 4px 8px;
            margin: 0 3px;
            background: var(--bg-primary);
            border-radius: 3px;
            color: var(--text-primary);
            font-weight: 500;
            border: 1px solid var(--border);
        }
        
        /* Adjust game container to account for reference bar */
        body {
            padding-bottom: 45px;
        }
        
        /* ========================================
           START SCREEN
           ======================================== */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #0f1923 100%);
            padding: 40px;
            overflow-y: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .start-content {
            max-width: 700px;
            width: 100%;
        }
        
        .start-title {
            font-size: 42px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
        }
        
        .start-subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 16px;
            margin-bottom: 40px;
        }
        
        .start-section {
            background: var(--bg-panel);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }
        
        .start-section h3 {
            color: var(--accent-cyan);
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }
        
        .timer-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .timer-btn {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border: none;
            color: white;
            padding: 18px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 8px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 2px 8px rgba(74, 158, 255, 0.3);
            min-height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .timer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(74, 158, 255, 0.5);
        }
        
        .timer-btn:active {
            transform: translateY(0);
        }
        
        .start-info {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.7;
        }
        
        .start-info ul {
            margin: 15px 0;
            padding-left: 25px;
        }
        
        .start-info li {
            margin: 8px 0;
        }
        
        .start-info strong {
            color: var(--accent-cyan);
        }
        
        /* ========================================
           MOBILE ADJUSTMENTS FOR START SCREEN
           ======================================== */
        @media (max-width: 900px) {
            #start-screen {
                padding: 25px 20px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .start-title {
                font-size: 32px;
            }
            
            .start-section {
                padding: 20px;
            }
            
            .timer-btn {
                font-size: 14px;
                padding: 16px;
                min-height: 50px;
            }
            
            #structures-reference {
                font-size: 10px;
                padding: 8px 10px;
                overflow-x: auto;
            }
            
            .structure-name {
                padding: 3px 6px;
                margin: 0 2px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Start Screen -->
    <div id="start-screen" style="display: block;">
        <div class="start-content">
            <div class="start-title">‚öïÔ∏è ER TRAUMA</div>
            <div class="start-subtitle">Medical Training Simulation ‚Ä¢ Neuroanatomy Diagnostics</div>
            
            <div class="start-section">
                <h3>‚è±Ô∏è SELECT TIMER MODE:</h3>
                <div class="timer-options">
                <button class="timer-btn" data-timer="60">‚ö° 1 MINUTE - Hardcore Mode</button>
                <button class="timer-btn" data-timer="120">‚è±Ô∏è 2 MINUTES - Challenge Mode</button>
                <button class="timer-btn" data-timer="180">üïê 3 MINUTES - Standard Mode</button>
                <button class="timer-btn" data-timer="300">üïî 5 MINUTES - Learning Mode</button>
                <button class="timer-btn" data-timer="-1">‚àû NO TIMER - Practice Mode</button>
            </div>
        </div>
        
        <div class="start-section">
            <div class="start-info">
                <strong style="color: #00ffff;">HOW TO PLAY:</strong><br>
                ‚Ä¢ Type commands to examine evidence<br>
                ‚Ä¢ Use CHOICES or HINT if you need help<br>
                ‚Ä¢ Type DIAGNOSE [structure] to submit<br>
                ‚Ä¢ You get 3 attempts per case<br>
                ‚Ä¢ First try = max points + time bonus<br><br>
                
                <strong style="color: #00ffff;">AVAILABLE COMMANDS:</strong><br>
                LOOK, EXAMINE PATIENT, READ CHART, CHECK CT SCAN<br>
                DIAGNOSE [structure], CHOICES, HINT, HELP<br><br>
                
                <strong>üìã All brain structure names shown at bottom!</strong>
            </div>
        </div>
        </div>
    </div>
    
    <!-- HUD -->
    <div id="hud">
        <div class="hud-item">CASE: <span id="case-number">1/5</span></div>
        <div class="hud-item">SCORE: <span id="score">0</span></div>
        <div class="hud-item">ATTEMPTS: <span id="attempts">0</span></div>
        <div class="hud-item" id="timer">TIME: 60s</div>
    </div>
    
    <!-- Game Container -->
    <div id="game-container">
        <!-- Output Terminal -->
        <div id="output"></div>
        
        <!-- Input -->
        <div id="input-container">
            <span id="input-prompt">&gt;</span>
            <input type="text" id="command-input" autocomplete="off" autocapitalize="off" autocorrect="on" spellcheck="true" inputmode="text" placeholder="Type command...">
            <button id="submit-btn">GO</button>
        </div>
    </div>
    
    <!-- Brain Structures Reference Bar -->
    <div id="structures-reference">
        <span class="reference-label">Structures:</span>
        <span class="structure-name">Amygdala</span>
        <span class="structure-name">Basal Ganglia</span>
        <span class="structure-name">Broca's Area</span>
        <span class="structure-name">Cerebellum</span>
        <span class="structure-name">Corpus Callosum</span>
        <span class="structure-name">Frontal Lobe</span>
        <span class="structure-name">Hippocampus</span>
        <span class="structure-name">Hypothalamus</span>
        <span class="structure-name">Medulla Oblongata</span>
        <span class="structure-name">Occipital Lobe</span>
        <span class="structure-name">Pons</span>
        <span class="structure-name">Reticular Formation</span>
        <span class="structure-name">Spinal Cord</span>
        <span class="structure-name">Thalamus</span>
        <span class="structure-name">Wernicke's Area</span>
    </div>
    
    <!-- Instruction Popup -->
    <div id="instruction-popup">
        <div class="popup-content">
            <div class="popup-title">‚öïÔ∏è ER TRAUMA DIAGNOSTICS ‚öïÔ∏è</div>
            
            <div class="popup-section">
                <h3>üéØ What You'll Learn</h3>
                <p>Diagnose brain injuries by examining patients and identifying which brain structure is damaged based on symptoms. Master neuroanatomy through realistic clinical scenarios!</p>
            </div>
            
            <div class="popup-section">
                <h3>üìö Standards Covered</h3>
                <div class="standards-box">
                    <strong>AP Psychology:</strong> Unit 2 - Biological Bases of Behavior<br>
                    ‚Ä¢ Brain structure locations and functions<br>
                    ‚Ä¢ Effects of brain damage on behavior and cognition<br>
                    ‚Ä¢ Neuroanatomy and nervous system organization
                </div>
                <div class="standards-box">
                    <strong>Texas Dual Credit (TEKS 130.283):</strong><br>
                    ‚Ä¢ (c)(3) Biological bases of behavior<br>
                    ‚Ä¢ All 15 major brain structures: Medulla, Cerebellum, Hippocampus, Amygdala, Hypothalamus, Thalamus, Frontal Lobe, Occipital Lobe, Pons, Corpus Callosum, Basal Ganglia, Reticular Formation, Spinal Cord, Broca's Area, Wernicke's Area
                </div>
            </div>
            
            <div class="popup-section">
                <h3>üéÆ How to Play</h3>
                <ul>
                    <li><strong>Examine evidence:</strong> LOOK, EXAMINE PATIENT, READ CHART, CHECK CT SCAN</li>
                    <li><strong>Submit diagnosis:</strong> Type DIAGNOSE [structure name]</li>
                    <li><strong>Need help?</strong> CHOICES (3 options) or HINT (50 pts max)</li>
                    <li><strong>3 attempts per case</strong> - First try = 100 points + time bonus!</li>
                    <li><strong>Structure names shown at top</strong> for easy reference</li>
                </ul>
            </div>
            
            <div class="popup-section">
                <h3>üí° Pro Tips</h3>
                <ul>
                    <li>Read ALL symptoms carefully before diagnosing</li>
                    <li>Check BOTH the chart AND CT scan for clues</li>
                    <li>Use CHOICES if unsure - no point penalty!</li>
                    <li>Type HELP anytime to see all commands</li>
                </ul>
            </div>
            
            <button id="got-it-btn">LET'S START! üöÄ</button>
        </div>
    </div>
    
    <script>
        console.log('Script started loading...');
        
        // ==============================================
        // GLOBAL FUNCTIONS (Must be defined first for onclick handlers)
        // ==============================================
        
        function startGame(seconds) {
            console.log('=== START GAME CALLED ===');
            console.log('Timer seconds:', seconds);
            
            gameState.timerSeconds = seconds;
            gameState.timerEnabled = seconds !== -1;
            
            // Remove start screen
            const startScreen = document.getElementById('start-screen');
            if (startScreen) {
                startScreen.remove();
                console.log('Start screen removed');
            }
            
            // Show instruction popup FIRST
            const popup = document.getElementById('instruction-popup');
            if (popup) {
                popup.style.display = 'flex';
            }
            
            // Set up the "Got it!" button
            const gotItBtn = document.getElementById('got-it-btn');
            if (gotItBtn) {
                gotItBtn.onclick = function() {
                    // Hide popup
                    popup.style.display = 'none';
                    
                    // Show game elements
                    const hud = document.getElementById('hud');
                    const gameContainer = document.getElementById('game-container');
                    const refBar = document.getElementById('structures-reference');
                    
                    if (hud) hud.style.display = 'flex';
                    if (gameContainer) gameContainer.style.display = 'flex';
                    if (refBar) refBar.style.display = 'block';
                    
                    console.log('Game elements visible');
                    
                    // Initialize game
                    initGame();
                    
                    // Focus input aggressively (especially for mobile)
                    setTimeout(() => {
                        const input = document.getElementById('command-input');
                        if (input) {
                            input.focus();
                            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }, 300);
                    
                    // Keep focusing on mobile
                    setTimeout(() => {
                        const input = document.getElementById('command-input');
                        if (input && window.innerWidth <= 900) {
                            input.focus();
                        }
                    }, 800);
                };
            }
        }
        
        // ==============================================
        // GAME DATA AND STATE
        // ==============================================
        
        // CASE DATABASE
        const ALL_CASES = [
            {
                id: 1,
                structure: 'medulla oblongata',
                patientName: 'Rodriguez, Marcus',
                age: '38M',
                patientDesc: 'Patient is unconscious and cannot breathe on his own. A machine is breathing for him.',
                chartText: 'PATIENT NOTES - Rodriguez, Marcus (38M)\n\nWhat happened: Car accident with head injury\n\nWhat we observe:\n‚Ä¢ Cannot breathe without machine help\n‚Ä¢ Heart rhythm is abnormal\n‚Ä¢ Completely unconscious\n‚Ä¢ Body temperature regulation is unstable\n\nNote: All these are automatic body functions that we don\'t consciously control',
                ctScanText: 'BRAIN SCAN NOTES\n\nWhere the damage is:\n‚Ä¢ At the VERY BOTTOM of the brainstem\n‚Ä¢ Right where the brain connects to the spinal cord\n‚Ä¢ The LOWEST part of the brain\n\nWhat this means:\n‚Ä¢ This area controls heartbeat and breathing\n‚Ä¢ It controls automatic survival functions\n‚Ä¢ Damage here is very serious',
                diagnosis: 'medulla oblongata',
                alternateNames: ['medulla', 'medullaoblongata']
            },
            {
                id: 2,
                structure: 'cerebellum',
                patientName: 'Chen, Lisa',
                age: '52F',
                patientDesc: 'Patient cannot walk straight and keeps losing her balance. Her hands shake when she tries to pick things up.',
                chartText: 'PATIENT NOTES - Chen, Lisa (52F)\n\nWhat happened: Fell down stairs and hit back of head\n\nWhat we observe:\n‚Ä¢ Cannot walk in a straight line\n‚Ä¢ Hands shake when reaching for objects\n‚Ä¢ Has trouble with balance\n‚Ä¢ Speech sounds clumsy and slurred\n‚Ä¢ Movements are jerky and uncoordinated\n\nNote: All motor skills (coordinated movement) seem affected',
                ctScanText: 'BRAIN SCAN NOTES\n\nWhere the damage is:\n‚Ä¢ At the BACK of the brain, below the main part\n‚Ä¢ UNDERNEATH the occipital lobe\n‚Ä¢ Behind the brainstem\n\nWhat this means:\n‚Ä¢ This is the coordination center of the brain\n‚Ä¢ It fine-tunes movements and balance\n‚Ä¢ Often called the "little brain"',
                diagnosis: 'cerebellum',
                alternateNames: []
            },
            {
                id: 3,
                structure: 'hippocampus',
                patientName: 'Williams, James',
                age: '67M',
                patientDesc: 'Patient keeps asking "Where am I?" and "What happened?" every few minutes. He doesn\'t remember asking before.',
                chartText: 'PATIENT NOTES - Williams, James (67M)\n\nWhat happened: Stroke affecting memory area\n\nWhat we observe:\n‚Ä¢ Asks same questions over and over\n‚Ä¢ Cannot remember anything NEW\n‚Ä¢ Remembers his childhood perfectly\n‚Ä¢ Remembers his name and family\n‚Ä¢ But cannot remember what happened 5 minutes ago\n‚Ä¢ Cannot form new memories at all\n\nNote: OLD memories are fine, but NEW memory formation is broken',
                ctScanText: 'BRAIN SCAN NOTES\n\nWhere the damage is:\n‚Ä¢ DEEP inside the temporal lobes (both sides)\n‚Ä¢ Seahorse-shaped structures\n‚Ä¢ Part of the limbic system\n\nWhat this means:\n‚Ä¢ This area transfers new experiences into long-term memory\n‚Ä¢ Damage prevents NEW memories from forming\n‚Ä¢ Like your "save button" is broken',
                diagnosis: 'hippocampus',
                alternateNames: []
            },
            {
                id: 4,
                structure: 'amygdala',
                patientName: 'Patel, Riya',
                age: '29F',
                patientDesc: 'Patient is unusually calm and tried to pet an aggressive dog. Shows no fear of anything.',
                chartText: 'PATIENT NOTES - Patel, Riya (29F)\n\nWhat happened: Injury affecting emotion area\n\nWhat we observe:\n‚Ä¢ Shows NO fear response at all\n‚Ä¢ Approached a dangerous dog without hesitation\n‚Ä¢ Trusts complete strangers immediately\n‚Ä¢ Cannot recognize when someone looks angry or scared\n‚Ä¢ Acts inappropriately friendly with everyone\n‚Ä¢ No sense of danger\n\nNote: She literally cannot feel fear anymore',
                ctScanText: 'BRAIN SCAN NOTES\n\nWhere the damage is:\n‚Ä¢ DEEP in the temporal lobes (both sides)\n‚Ä¢ Near the hippocampus\n‚Ä¢ Almond-shaped structures\n‚Ä¢ Part of the limbic system\n\nWhat this means:\n‚Ä¢ This is the brain\'s "alarm system"\n‚Ä¢ It processes emotions, especially fear\n‚Ä¢ Damage = no fear response',
                diagnosis: 'amygdala',
                alternateNames: []
            },
            {
                id: 5,
                structure: 'frontal lobe',
                patientName: 'Thompson, Alex',
                age: '41M',
                patientDesc: 'Patient is making inappropriate jokes and rude comments. His family says his personality has completely changed.',
                chartText: 'PATIENT NOTES - Thompson, Alex (41M)\n\nWhat happened: Frontal head injury in car crash\n\nWhat we observe:\n‚Ä¢ Complete personality change\n‚Ä¢ Makes rude comments to staff\n‚Ä¢ Cannot plan or organize thoughts\n‚Ä¢ Very impulsive - does things without thinking\n‚Ä¢ Poor judgment and decision making\n‚Ä¢ Ignores social rules\n\nNote: He seems like a completely different person now',
                ctScanText: 'BRAIN SCAN NOTES\n\nWhere the damage is:\n‚Ä¢ At the FRONT of the brain (behind forehead)\n‚Ä¢ The largest lobe of the brain\n‚Ä¢ The area we evolved most recently\n\nWhat this means:\n‚Ä¢ This is your "executive" - makes decisions and plans\n‚Ä¢ Controls personality and social behavior\n‚Ä¢ The "CEO" of your brain',
                diagnosis: 'frontal lobe',
                alternateNames: ['frontallobe']
            },
            {
                id: 6,
                structure: 'pons',
                patientName: 'Martinez, Carmen',
                age: '55F',
                patientDesc: 'Patient is awake and aware. She can blink and move her eyes. But she cannot move or speak at all.',
                chartText: 'PATIENT NOTES - Martinez, Carmen (55F)\n\nWhat happened: Brainstem stroke\n\nWhat we observe:\n‚Ä¢ Completely paralyzed - cannot move body\n‚Ä¢ Cannot speak\n‚Ä¢ IS fully conscious and aware\n‚Ä¢ Can blink on command\n‚Ä¢ Can move eyes up and down\n‚Ä¢ Understands everything we say\n\nNote: This is called "locked-in syndrome" - aware but trapped',
                ctScanText: 'BRAIN SCAN NOTES\n\nWhere the damage is:\n‚Ä¢ In the MIDDLE of the brainstem\n‚Ä¢ Between the medulla (bottom) and midbrain (top)\n‚Ä¢ Acts as a "bridge" for signals\n\nWhat this means:\n‚Ä¢ Motor signals from brain cannot get through\n‚Ä¢ She can think but cannot move\n‚Ä¢ Consciousness is preserved',
                diagnosis: 'pons',
                alternateNames: []
            },
            {
                id: 7,
                structure: 'occipital lobe',
                patientName: 'Anderson, Kyle',
                age: '33M',
                patientDesc: 'Patient says he cannot see anything. His eyes are open and working normally, but he reports complete darkness.',
                chartText: 'PATIENT NOTES - Anderson, Kyle (33M)\n\nWhat happened: Hit back of head\n\nWhat we observe:\n‚Ä¢ Says everything is completely black\n‚Ä¢ Eyes are physically normal\n‚Ä¢ Pupils react to light normally\n‚Ä¢ Can describe objects by TOUCH\n‚Ä¢ Can describe objects by SOUND\n‚Ä¢ Just cannot SEE anything\n\nNote: Eyes work fine - brain just cannot process visual information',
                ctScanText: 'BRAIN SCAN NOTES\n\nWhere the damage is:\n‚Ä¢ At the VERY BACK of the brain\n‚Ä¢ Both sides damaged\n‚Ä¢ The smallest lobe of cerebral cortex\n\nWhat this means:\n‚Ä¢ This is where visual information is processed\n‚Ä¢ Eyes send signals, but brain cannot understand them\n‚Ä¢ Like a computer monitor breaking',
                diagnosis: 'occipital lobe',
                alternateNames: ['occipitallobe']
            },
            {
                id: 8,
                structure: 'thalamus',
                patientName: 'Kim, Sarah',
                age: '48F',
                patientDesc: 'Patient cannot feel anything on the right side of her body. No touch, no temperature, no pain.',
                chartText: 'PATIENT NOTES - Kim, Sarah (48F)\n\nWhat happened: Deep brain stroke\n\nWhat we observe:\n‚Ä¢ Right side: Cannot feel ANYTHING\n‚Ä¢ No sense of touch\n‚Ä¢ No sense of temperature\n‚Ä¢ No sense of pain\n‚Ä¢ CAN still move right side normally\n‚Ä¢ Left side is completely normal\n\nNote: Movement works but sensation does not',
                ctScanText: 'BRAIN SCAN NOTES\n\nWhere the damage is:\n‚Ä¢ DEEP in the center of the brain\n‚Ä¢ Egg-shaped structure\n‚Ä¢ Acts as a relay station\n\nWhat this means:\n‚Ä¢ ALL sensory information passes through here\n‚Ä¢ Like a switchboard operator\n‚Ä¢ Damage blocks all sensations from getting through',
                diagnosis: 'thalamus',
                alternateNames: []
            },
            {
                id: 9,
                structure: "wernicke's area",
                patientName: 'Brown, David',
                age: '61M',
                patientDesc: 'Patient is talking a lot, but his words make no sense. He also does not understand what you say to him.',
                chartText: "PATIENT NOTES - Brown, David (61M)\n\nWhat happened: Stroke in left temporal lobe\n\nWhat we observe:\n‚Ä¢ Speaks in complete sentences\n‚Ä¢ Grammar is correct\n‚Ä¢ But words are nonsense: 'The blue yesterday needs my floor'\n‚Ä¢ Does NOT understand questions\n‚Ä¢ Does not realize his speech makes no sense\n‚Ä¢ Can still hear normally\n\nNote: Speech PRODUCTION works, but UNDERSTANDING language is broken",
                ctScanText: 'BRAIN SCAN NOTES\n\nWhere the damage is:\n‚Ä¢ In the LEFT temporal lobe\n‚Ä¢ Upper back part of temporal lobe\n‚Ä¢ Near where you hear sounds\n\nWhat this means:\n‚Ä¢ This is the language COMPREHENSION center\n‚Ä¢ You need this to UNDERSTAND speech\n‚Ä¢ Damage = fluent but meaningless speech',
                diagnosis: "wernicke's area",
                alternateNames: ['wernickes area', 'wernicke area', 'wernickes']
            },
            {
                id: 10,
                structure: "broca's area",
                patientName: 'Garcia, Maria',
                age: '58F',
                patientDesc: 'Patient understands everything you say but cannot speak. She is very frustrated and can only say "yes" and "no".',
                chartText: "PATIENT NOTES - Garcia, Maria (58F)\n\nWhat happened: Stroke in left frontal lobe\n\nWhat we observe:\n‚Ä¢ UNDERSTANDS language perfectly\n‚Ä¢ Can read and comprehend\n‚Ä¢ CANNOT speak\n‚Ä¢ Can only say simple words like 'yes' and 'no'\n‚Ä¢ Gets very frustrated trying to talk\n‚Ä¢ Can write a little bit\n\nNote: She knows what she wants to say, but cannot make the words come out",
                ctScanText: 'BRAIN SCAN NOTES\n\nWhere the damage is:\n‚Ä¢ In the LEFT frontal lobe\n‚Ä¢ Lower part near motor area\n‚Ä¢ Controls face and mouth movements\n\nWhat this means:\n‚Ä¢ This is the speech PRODUCTION center\n‚Ä¢ You need this to SPEAK words\n‚Ä¢ Damage = understands but cannot talk',
                diagnosis: "broca's area",
                alternateNames: ['brocas area', 'broca area', 'brocas']
            },
            {
                id: 11,
                structure: 'hypothalamus',
                patientName: 'Lee, Michael',
                age: '44M',
                patientDesc: 'Patient is constantly eating and drinking. Says he feels extremely hungry and thirsty all the time.',
                chartText: 'PATIENT NOTES - Lee, Michael (44M)\n\nWhat happened: Brain tumor affecting regulation center\n\nWhat we observe:\n‚Ä¢ Feels EXTREMELY hungry constantly\n‚Ä¢ Feels EXTREMELY thirsty constantly\n‚Ä¢ Body temperature keeps changing\n‚Ä¢ Sleep schedule is completely disrupted\n‚Ä¢ Cannot regulate basic body needs\n\nNote: All automatic regulation systems are malfunctioning',
                ctScanText: 'BRAIN SCAN NOTES\n\nWhere the damage is:\n‚Ä¢ BELOW the thalamus (hence the name)\n‚Ä¢ Very small but very important\n‚Ä¢ Connected to pituitary gland\n\nWhat this means:\n‚Ä¢ This controls hunger, thirst, temperature\n‚Ä¢ Like your body\'s "thermostat" and "fuel gauge"\n‚Ä¢ Controls hormones and basic drives',
                diagnosis: 'hypothalamus',
                alternateNames: []
            },
            {
                id: 12,
                structure: 'corpus callosum',
                patientName: 'White, Rachel',
                age: '35F',
                patientDesc: 'Patient seems to have two separate minds. Her left hand does things her right hand is trying to undo.',
                chartText: 'PATIENT NOTES - White, Rachel (35F)\n\nWhat happened: Surgery to control seizures\n\nWhat we observe:\n‚Ä¢ Left and right hands "fight" each other\n‚Ä¢ Cannot name objects shown to left visual field\n‚Ä¢ CAN name objects in right visual field\n‚Ä¢ Left hand seems to act on its own\n‚Ä¢ Cannot transfer information between sides\n\nNote: It\'s like her two brain hemispheres cannot communicate',
                ctScanText: 'BRAIN SCAN NOTES\n\nWhere the damage is:\n‚Ä¢ Large bundle connecting two hemispheres\n‚Ä¢ Runs down middle of brain\n‚Ä¢ Biggest structure of white matter\n\nWhat this means:\n‚Ä¢ This is the "cable" connecting left and right brain\n‚Ä¢ Contains 200+ million nerve fibers\n‚Ä¢ Damage = disconnected hemispheres',
                diagnosis: 'corpus callosum',
                alternateNames: ['corpuscallosum']
            },
            {
                id: 13,
                structure: 'basal ganglia',
                patientName: 'Johnson, Robert',
                age: '59M',
                patientDesc: 'Patient has constant tremors and jerky movements. Cannot control his body movements smoothly.',
                chartText: 'PATIENT NOTES - Johnson, Robert (59M)\n\nWhat happened: Progressive neurological condition\n\nWhat we observe:\n‚Ä¢ Constant shaking (tremors)\n‚Ä¢ Movements are stiff and rigid\n‚Ä¢ Cannot start movements easily\n‚Ä¢ Walks with shuffling steps\n‚Ä¢ Face shows little expression\n‚Ä¢ Has difficulty with automatic movements\n\nNote: Voluntary movement is very difficult and uncoordinated',
                ctScanText: 'BRAIN SCAN NOTES\n\nWhere the damage is:\n‚Ä¢ Deep inside brain near center\n‚Ä¢ Group of connected structures\n‚Ä¢ Near thalamus\n\nWhat this means:\n‚Ä¢ These control smooth voluntary movements\n‚Ä¢ Help coordinate and plan motor actions\n‚Ä¢ Damage causes movement disorders',
                diagnosis: 'basal ganglia',
                alternateNames: ['basalganglia']
            },
            {
                id: 14,
                structure: 'reticular formation',
                patientName: 'Davis, Jennifer',
                age: '42F',
                patientDesc: 'Patient cannot stay awake. She seems alert one moment, then falls asleep the next.',
                chartText: 'PATIENT NOTES - Davis, Jennifer (42F)\n\nWhat happened: Brainstem injury\n\nWhat we observe:\n‚Ä¢ Cannot maintain alertness\n‚Ä¢ Keeps falling asleep unexpectedly\n‚Ä¢ Alertness level goes up and down\n‚Ä¢ Cannot focus attention\n‚Ä¢ Sleep-wake cycle is disrupted\n\nNote: She cannot control her consciousness level',
                ctScanText: 'BRAIN SCAN NOTES\n\nWhere the damage is:\n‚Ä¢ Network throughout the brainstem\n‚Ä¢ Runs through medulla, pons, and midbrain\n‚Ä¢ Like a web or net (hence "reticular")\n\nWhat this means:\n‚Ä¢ This controls arousal and alertness\n‚Ä¢ The brain\'s "on/off switch"\n‚Ä¢ Keeps you awake and aware',
                diagnosis: 'reticular formation',
                alternateNames: ['reticularformation']
            },
            {
                id: 15,
                structure: 'spinal cord',
                patientName: 'Miller, Chris',
                age: '28M',
                patientDesc: 'Patient cannot feel or move anything below his chest. Arms work fine but everything below is paralyzed.',
                chartText: 'PATIENT NOTES - Miller, Chris (28M)\n\nWhat happened: Diving accident\n\nWhat we observe:\n‚Ä¢ Arms and hands work normally\n‚Ä¢ Cannot move legs at all\n‚Ä¢ Cannot feel anything below chest\n‚Ä¢ No sensation in lower body\n‚Ä¢ Brain is completely normal\n‚Ä¢ Issue is in the neck\n\nNote: The connection between brain and body is severed',
                ctScanText: 'SCAN NOTES\n\nWhere the damage is:\n‚Ä¢ In the NECK region\n‚Ä¢ Not actually in the brain itself\n‚Ä¢ The bundle of nerves going down the spine\n\nWhat this means:\n‚Ä¢ This carries ALL signals between brain and body\n‚Ä¢ Like cutting a telephone cable\n‚Ä¢ Brain is fine but cannot communicate with lower body',
                diagnosis: 'spinal cord',
                alternateNames: ['spinalcord']
            }
        ];
        
        // Game state
        let gameState = {
            currentCaseIndex: 0,
            selectedCases: [],
            timeRemaining: 60,
            timerSeconds: 60, // Selected timer duration
            totalScore: 0,
            attempts: 0,
            timerActive: false,
            timerEnabled: true, // Whether timer is enabled at all
            caseFailed: false, // Track if case failed due to time
            usedHint: false,
            usedChoices: false,
            examinedItems: {
                patient: false,
                chart: false,
                ctscan: false
            }
        };
        
        // Fisher-Yates shuffle algorithm (truly random)
        function fisherYatesShuffle(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }
        
        function initGame() {
            // Select 5 random cases using proper randomization
            const shuffled = fisherYatesShuffle(ALL_CASES);
            gameState.selectedCases = shuffled.slice(0, 5);
            
            // Log selected cases for debugging
            console.log('Cases for this game:', gameState.selectedCases.map(c => c.structure));
            
            // Load first case
            loadCase(0);
        }
        
        function loadCase(index) {
            if (index >= gameState.selectedCases.length) {
                gameState.timerActive = false;
                printLine('');
                printLine('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
                printLine('üèÜ ALL CASES COMPLETE!', 'success');
                printLine('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
                printLine('');
                printLine(`FINAL SCORE: ${gameState.totalScore} points`, 'success');
                printLine(`Cases solved: ${index}/5`, 'info');
                printLine('');
                printLine('Type RESTART to play again.', 'info');
                return;
            }
            
            gameState.currentCaseIndex = index;
            gameState.timeRemaining = gameState.timerSeconds;
            gameState.timerActive = gameState.timerEnabled;
            gameState.attempts = 0;
            gameState.caseFailed = false;
            gameState.usedHint = false;
            gameState.usedChoices = false;
            gameState.examinedItems = { patient: false, chart: false, ctscan: false };
            
            document.getElementById('case-number').textContent = `${index + 1}/5`;
            document.getElementById('attempts').textContent = '0';
            
            // Update timer display
            const timerEl = document.getElementById('timer');
            if (gameState.timerEnabled) {
                const minutes = Math.floor(gameState.timeRemaining / 60);
                const seconds = gameState.timeRemaining % 60;
                timerEl.textContent = `TIME: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                timerEl.className = 'hud-item';
            } else {
                timerEl.textContent = 'TIME: ‚àû';
                timerEl.className = 'hud-item';
            }
            
            const currentCase = gameState.selectedCases[index];
            
            printLine('');
            printLine('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            printLine(`‚öïÔ∏è  NEW TRAUMA CASE - ${currentCase.patientName}`, 'info');
            printLine('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            printLine('');
            if (gameState.timerEnabled) {
                const mins = Math.floor(gameState.timeRemaining / 60);
                printLine(`A patient has just arrived in the ER. You have ${mins} minute${mins !== 1 ? 's' : ''} to diagnose.`, 'info');
            } else {
                printLine('A patient has just arrived in the ER. Take your time to diagnose.', 'info');
            }
            printLine('');
            printLine('AVAILABLE COMMANDS:', 'info');
            printLine('  LOOK - Examine the room', 'commands-list');
            printLine('  EXAMINE PATIENT - Check the patient', 'commands-list');
            printLine('  READ CHART - View patient chart', 'commands-list');
            printLine('  CHECK CT SCAN - Review imaging results', 'commands-list');
            printLine('  DIAGNOSE [structure] - Submit your diagnosis', 'commands-list');
            printLine('  HELP - Show all commands', 'commands-list');
            printLine('');
            printLine('Type LOOK to begin.', 'prompt');
            printLine('');
            
            if (gameState.timerEnabled) {
                const mins = Math.floor(gameState.timeRemaining / 60);
                const secs = gameState.timeRemaining % 60;
                printLine('‚è±Ô∏è  TIMER STARTED! Watch the top-right corner!', 'warning');
                printLine('');
                startTimer();
            }
        }
        
        function startTimer() {
            const timerInterval = setInterval(() => {
                if (gameState.timerActive && gameState.timerEnabled) {
                    gameState.timeRemaining--;
                    
                    const timerEl = document.getElementById('timer');
                    const minutes = Math.floor(gameState.timeRemaining / 60);
                    const seconds = gameState.timeRemaining % 60;
                    timerEl.textContent = `TIME: ${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (gameState.timeRemaining <= 10) {
                        timerEl.className = 'hud-item critical';
                    } else if (gameState.timeRemaining <= 30) {
                        timerEl.className = 'hud-item warning';
                    }
                    
                    if (gameState.timeRemaining <= 0) {
                        gameState.timerActive = false;
                        gameState.caseFailed = true;
                        clearInterval(timerInterval);
                        printLine('');
                        printLine('‚è∞ TIME EXPIRED!', 'error');
                        printLine('The patient needed immediate diagnosis. Case failed.', 'error');
                        printLine('');
                        printLine('Moving to next case...', 'info');
                        
                        // Auto-advance after 3 seconds
                        setTimeout(() => {
                            loadCase(gameState.currentCaseIndex + 1);
                        }, 3000);
                    }
                }
            }, 1000);
        }
        
        function processCommand(cmd) {
            const command = cmd.toLowerCase().trim();
            const currentCase = gameState.selectedCases[gameState.currentCaseIndex];
            
            printLine(`> ${cmd}`, 'prompt');
            
            if (command === 'look') {
                printLine('');
                printLine('‚ïê‚ïê‚ïê ER TRAUMA BAY ‚ïê‚ïê‚ïê', 'info');
                printLine('');
                printLine(currentCase.patientDesc);
                printLine('');
                printLine('You can see:', 'info');
                printLine('  - PATIENT on gurney', 'commands-list');
                printLine('  - CHART on clipboard', 'commands-list');
                printLine('  - CT SCAN viewer on wall', 'commands-list');
                printLine('');
                
            } else if (command === 'examine patient' || command === 'check patient' || command === 'look at patient') {
                gameState.examinedItems.patient = true;
                printLine('');
                printLine(currentCase.patientDesc);
                printLine('');
                printLine('Read the CHART and check the CT SCAN for more information.', 'info');
                printLine('');
                
            } else if (command === 'read chart' || command === 'check chart' || command === 'look at chart') {
                gameState.examinedItems.chart = true;
                printLine('');
                printLine('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                printLine(currentCase.chartText);
                printLine('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                printLine('');
                
            } else if (command === 'check ct scan' || command === 'read ct scan' || command === 'check ct' || command === 'look at ct scan' || command === 'examine ct scan') {
                gameState.examinedItems.ctscan = true;
                printLine('');
                printLine('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                printLine(currentCase.ctScanText);
                printLine('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                printLine('');
                
            } else if (command.startsWith('diagnose ')) {
                const diagnosis = command.replace('diagnose ', '').trim();
                submitDiagnosis(diagnosis);
                
            } else if (command === 'cases') {
                printLine('');
                printLine('‚ïê‚ïê‚ïê CASES IN THIS GAME ‚ïê‚ïê‚ïê', 'info');
                printLine('');
                for (let i = 0; i < gameState.selectedCases.length; i++) {
                    const caseInfo = gameState.selectedCases[i];
                    const status = i < gameState.currentCaseIndex ? '‚úì Completed' : 
                                   i === gameState.currentCaseIndex ? '‚Üê Current' : 
                                   'Not yet';
                    printLine(`${i + 1}. ${caseInfo.patientName} (${caseInfo.age}) - ${status}`);
                }
                printLine('');
                printLine('Note: Brain structure is not shown to prevent spoilers!', 'info');
                printLine('');
                
            } else if (command === 'help') {
                printLine('');
                printLine('‚ïê‚ïê‚ïê AVAILABLE COMMANDS ‚ïê‚ïê‚ïê', 'info');
                printLine('');
                printLine('LOOK - Examine the room');
                printLine('EXAMINE PATIENT - Check the patient');
                printLine('READ CHART - View patient chart');
                printLine('CHECK CT SCAN - Review CT imaging');
                printLine('DIAGNOSE [structure] - Submit diagnosis');
                printLine('  Example: DIAGNOSE MEDULLA OBLONGATA');
                printLine('');
                printLine('üí° CHOICES - Get 3 multiple choice options');
                printLine('üí° HINT - Get a clue (max 50 points)');
                printLine('');
                printLine('CASES - Show which cases are in this game');
                printLine('NEXT - Skip to next case');
                printLine('RESTART - Start over');
                printLine('');
                printLine('üìã Structure names shown at bottom of screen!', 'info');
                printLine('');
                
            } else if (command === 'choices') {
                if (gameState.usedChoices) {
                    printLine('');
                    printLine('You already used CHOICES for this case!', 'warning');
                    printLine('');
                } else {
                    gameState.usedChoices = true;
                    const currentCase = gameState.selectedCases[gameState.currentCaseIndex];
                    const correctAnswer = currentCase.structure;
                    
                    // Get all possible structures
                    const allStructures = [
                        'amygdala', 'basal ganglia', "broca's area", 'cerebellum', 
                        'corpus callosum', 'frontal lobe', 'hippocampus', 'hypothalamus',
                        'medulla oblongata', 'occipital lobe', 'pons', 'reticular formation',
                        'spinal cord', 'thalamus', "wernicke's area"
                    ];
                    
                    // Get wrong answers (exclude correct answer)
                    const wrongAnswers = allStructures.filter(s => s !== correctAnswer);
                    
                    // Shuffle and pick 2 random wrong answers
                    const shuffled = fisherYatesShuffle(wrongAnswers);
                    const choices = [correctAnswer, shuffled[0], shuffled[1]];
                    
                    // Shuffle the 3 choices
                    const finalChoices = fisherYatesShuffle(choices);
                    
                    printLine('');
                    printLine('‚ïê‚ïê‚ïê MULTIPLE CHOICE ‚ïê‚ïê‚ïê', 'info');
                    printLine('');
                    printLine('Which brain structure is damaged?');
                    printLine('');
                    printLine('A) ' + finalChoices[0].toUpperCase());
                    printLine('B) ' + finalChoices[1].toUpperCase());
                    printLine('C) ' + finalChoices[2].toUpperCase());
                    printLine('');
                    printLine('Type: DIAGNOSE [structure name]', 'info');
                    printLine('');
                }
                
            } else if (command === 'hint') {
                if (gameState.usedHint) {
                    printLine('');
                    printLine('You already used HINT for this case!', 'warning');
                    printLine('');
                } else {
                    gameState.usedHint = true;
                    const currentCase = gameState.selectedCases[gameState.currentCaseIndex];
                    const structure = currentCase.structure;
                    
                    // Provide hints based on structure
                    const hints = {
                        'medulla oblongata': 'üí° This structure controls BREATHING and HEART RATE. It\'s at the base of the brainstem.',
                        'cerebellum': 'üí° This structure controls BALANCE and COORDINATION. It\'s the "little brain" at the back.',
                        'hippocampus': 'üí° This structure is crucial for forming NEW MEMORIES. Named after a seahorse.',
                        'amygdala': 'üí° This structure processes FEAR and EMOTIONS. It\'s almond-shaped.',
                        'thalamus': 'üí° This structure is the brain\'s RELAY STATION for sensory information.',
                        'hypothalamus': 'üí° This structure controls HUNGER, THIRST, and body temperature. It\'s below the thalamus.',
                        'frontal lobe': 'üí° This large lobe controls PLANNING and DECISION MAKING. It\'s at the front of the brain.',
                        'occipital lobe': 'üí° This lobe processes VISION. It\'s at the back of the brain.',
                        'pons': 'üí° This structure is a BRIDGE in the brainstem. It helps control breathing and sleep.',
                        'corpus callosum': 'üí° This structure CONNECTS the left and right brain hemispheres.',
                        'basal ganglia': 'üí° This group of structures controls VOLUNTARY MOVEMENT and habits.',
                        'spinal cord': 'üí° This structure carries signals between the brain and body. It\'s in the spine.',
                        'reticular formation': 'üí° This structure controls ALERTNESS and sleep-wake cycles.',
                        "broca's area": 'üí° This area controls SPEECH PRODUCTION. Damage causes inability to speak fluently.',
                        "wernicke's area": 'üí° This area controls LANGUAGE COMPREHENSION. Damage causes inability to understand speech.'
                    };
                    
                    printLine('');
                    printLine('‚ïê‚ïê‚ïê HINT ‚ïê‚ïê‚ïê', 'info');
                    printLine('');
                    printLine(hints[structure] || 'üí° Check the symptoms and CT scan carefully!');
                    printLine('');
                    printLine('‚ö†Ô∏è Using HINT limits you to 50 points maximum for this case.', 'warning');
                    printLine('');
                }
                
            } else if (command === 'next') {
                gameState.timerActive = false;
                loadCase(gameState.currentCaseIndex + 1);
                
            } else if (command === 'restart') {
                location.reload();
                
            } else {
                printLine('');
                printLine('Unknown command. Type HELP for available commands.', 'error');
                printLine('');
            }
        }
        
        function submitDiagnosis(diagnosis) {
            // Check if case already failed due to time expiration
            if (gameState.caseFailed) {
                printLine('');
                printLine('‚è∞ Time has expired for this case!', 'error');
                printLine('Moving to next case...', 'info');
                printLine('');
                return;
            }
            
            const currentCase = gameState.selectedCases[gameState.currentCaseIndex];
            
            // Check if diagnosis is correct (including alternate names)
            const isCorrect = diagnosis === currentCase.diagnosis || 
                             currentCase.alternateNames.includes(diagnosis);
            
            if (isCorrect) {
                // CORRECT!
                gameState.timerActive = false;
                
                let points = 0;
                let timeBonus = 0;
                
                if (gameState.attempts === 0) {
                    // First try - full points
                    points = 100;
                    if (gameState.timerEnabled && gameState.timeRemaining > 0) {
                        timeBonus = gameState.timeRemaining * 2;
                        points += timeBonus;
                    }
                } else if (gameState.attempts === 1) {
                    // Second try - half points, no time bonus
                    points = 50;
                } else if (gameState.attempts === 2) {
                    // Third try - minimal points
                    points = 25;
                } else {
                    // Fourth+ try - no points
                    points = 0;
                }
                
                // If they used a hint, cap at 50 points (no time bonus)
                if (gameState.usedHint) {
                    points = Math.min(points, 50);
                    timeBonus = 0; // No time bonus with hint
                }
                
                gameState.totalScore += points;
                document.getElementById('score').textContent = gameState.totalScore;
                
                printLine('');
                printLine('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
                printLine('‚úÖ CORRECT DIAGNOSIS!', 'success');
                printLine('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'success');
                printLine('');
                printLine(`Patient saved! +${points} points`, 'success');
                if (timeBonus > 0) {
                    printLine(`Time bonus: +${timeBonus} points`, 'success');
                }
                printLine(`Total score: ${gameState.totalScore}`, 'info');
                printLine('');
                printLine('Type NEXT to continue to next case.', 'info');
                printLine('');
                
            } else {
                // WRONG!
                gameState.attempts++;
                document.getElementById('attempts').textContent = gameState.attempts;
                
                // Point penalties
                if (gameState.attempts === 1) {
                    gameState.totalScore = Math.max(0, gameState.totalScore - 50);
                } else if (gameState.attempts === 2) {
                    gameState.totalScore = Math.max(0, gameState.totalScore - 25);
                } else {
                    gameState.totalScore = Math.max(0, gameState.totalScore - 10);
                }
                
                document.getElementById('score').textContent = gameState.totalScore;
                
                printLine('');
                printLine('‚ùå INCORRECT DIAGNOSIS!', 'error');
                printLine('');
                printLine(`Wrong answer. -${gameState.attempts === 1 ? 50 : gameState.attempts === 2 ? 25 : 10} points`, 'error');
                printLine(`Current score: ${gameState.totalScore}`, 'warning');
                printLine('');
                
                // Check if they've used up all 3 attempts
                if (gameState.attempts >= 3) {
                    const currentCase = gameState.selectedCases[gameState.currentCaseIndex];
                    printLine('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'warning');
                    printLine('‚ö†Ô∏è  OUT OF ATTEMPTS!', 'warning');
                    printLine('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'warning');
                    printLine('');
                    printLine(`The correct answer was: ${currentCase.structure.toUpperCase()}`, 'info');
                    printLine('');
                    printLine('Moving to next case...', 'warning');
                    printLine('');
                    gameState.timerActive = false;
                    setTimeout(() => loadCase(gameState.currentCaseIndex + 1), 3000);
                } else {
                    printLine(`üí° Type HINT for a clue or CHOICES for 3 options`, 'info');
                    printLine(`Attempts remaining: ${3 - gameState.attempts}`, 'info');
                    printLine('');
                }
            }
        }
        
        function printLine(text, className = '') {
            const line = document.createElement('div');
            line.className = `output-line ${className}`;
            line.textContent = text;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }
        
        // ==============================================
        // INITIALIZATION (Wait for DOM)
        // ==============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM ready, setting up event listeners...');
            
            const output = document.getElementById('output');
            const input = document.getElementById('command-input');
            const submitBtn = document.getElementById('submit-btn');
            
            if (!output || !input) {
                console.error('Critical elements missing!');
                return;
            }
            
            // ========================================
            // TIMER BUTTONS
            // ========================================
            const timerButtons = document.querySelectorAll('.timer-btn');
            console.log('Found', timerButtons.length, 'timer buttons');
            
            timerButtons.forEach((btn) => {
                btn.addEventListener('click', function() {
                    const seconds = parseInt(this.getAttribute('data-timer'));
                    console.log('Timer button clicked:', seconds);
                    startGame(seconds);
                });
                
                // Also handle touch for mobile
                btn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    const seconds = parseInt(this.getAttribute('data-timer'));
                    console.log('Timer button touched:', seconds);
                    startGame(seconds);
                });
            });
            
            // ========================================
            // INPUT HANDLING
            // ========================================
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && input.value.trim()) {
                    processCommand(input.value);
                    input.value = '';
                    setTimeout(() => input.focus(), 100);
                }
            });
            
            // Mobile submit button
            if (submitBtn) {
                submitBtn.addEventListener('click', () => {
                    if (input.value.trim()) {
                        processCommand(input.value);
                        input.value = '';
                        setTimeout(() => input.focus(), 100);
                    }
                });
            }
            
            // Ensure input stays focused on mobile
            input.addEventListener('blur', () => {
                if (window.innerWidth <= 900) {
                    setTimeout(() => {
                        if (document.activeElement !== input) {
                            input.focus();
                        }
                    }, 100);
                }
            });
            
            console.log('Game ready! Click a timer button to start.');
        });
    </script>
</body>
</html>
